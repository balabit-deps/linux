# default: snapshot build on test ZBS branch
# set RELEASE_VERSION when creating a release, for example: RELEASE_VERSION=0.0.4

stages:
  - validate-vars
  - build-libbpf
  #- package-kernel-headers

variables:
  GIT_DEPTH: 1

.linux-build-env: &linux-build-env
  image: docker.balabit/syslog-ng/base-centos6:v1
  only:
    variables:
      - $BUILD_PLATFORMS =~ /^(linux-glibc2.11/amd64|all|)$/
  before_script:
    - export DIST=linux-glibc2.11
    - export ARCH=amd64

.bionic-build-env: &bionic-build-env
  image: docker.balabit/syslog-ng/base-centos6:v1
  only:
    variables:
      - $BUILD_PLATFORMS =~ /^(ubuntu-bionic/amd64|all|)$/
  before_script:
    - export DIST=ubuntu-bionic
    - export ARCH=amd64

.build-libbpf: &build-libbpf
  script:
    - source /opt/rh/python27/enable

    - git clone git@git.balabit:syslog-ng/pe-builder-image.git
    - if [ ! -z "$RELEASE_VERSION" ]; then export SNAPSHOT=no ; fi
    - cd pe-builder-image && scripts/generate-ci-data.sh && export `cat ci-data.env` && cd -

    - export NAME=bootstrap
    - cat pe-builder-image/job.yml.tpl | envsubst | tee job.yml
    - pe-builder-image/playbook/roles/balabit.builder_cli/files/builder.py job.yml

    - export PKG_CONFIG_PATH="/opt/syslog-ng/lib/pkgconfig:$PKG_CONFIG_PATH"
    - export LIBRARY_PATH="$LIBRARY_PATH:/opt/syslog-ng/lib"
    - export EXTRA_CFLAGS="-isystem /opt/syslog-ng/include -Wl,-R/opt/syslog-ng/lib"

    # libbpf
    - DEST_DIR="${CI_PROJECT_DIR}/artifacts/=install"
    - LIBBPF_INSTALL_FLAGS="prefix=/opt/syslog-ng libdir=/opt/syslog-ng/lib DESTDIR=$DEST_DIR"
    - make -C ${CI_PROJECT_DIR}/tools/lib/bpf install install_headers $LIBBPF_INSTALL_FLAGS
    - cp ${CI_PROJECT_DIR}/tools/testing/selftests/bpf/{bpf_helpers.h,bpf_endian.h} $DEST_DIR/opt/syslog-ng/include/bpf

    # kernel headers - should be a separate job/package
    - make ARCH=x86_64 INSTALL_HDR_PATH=$DEST_DIR/opt/syslog-ng headers_install

    - pe-builder-image/scripts/prepare-binaries.sh libbpf
    - pe-builder-image/scripts/add-binaries.sh libbpf
    - rm -rf $DEST_DIR
  artifacts:
    expire_in: "2 weeks"
    when: always
    paths:
      - artifacts
      - pe-builder-image/ci-data.env

validate-vars:
  stage: validate-vars
  image: docker.balabit/syslog-ng/base-centos6:v1
  script:
    - if [ -z "$ZBS_BRANCH" -a "$SNAPSHOT" = "yes" ]; then exit 1; fi
    - if [ "$SNAPSHOT" = "no" -a -z "$RELEASE_VERSION" ]; then exit 1; fi;
  variables:
    GIT_STRATEGY: none

build-libbpf:linux:
  stage: build-libbpf
  <<: *linux-build-env
  <<: *build-libbpf

build-libbpf:bionic:
  stage: build-libbpf
  <<: *bionic-build-env
  <<: *build-libbpf
